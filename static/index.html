<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>28æ˜Ÿå®¿éŸ³ä¹ç”Ÿæˆå™¨ - 45ç§’éŸ³ä¹æ”¯æŒ</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0a0a23 0%, #1a1a3a 50%, #2a1a4a 100%);
            color: #ffffff;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
        }

        .control-panel {
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .star-canvas-container {
            flex: 1;
            position: relative;
        }

        #starCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #starCanvas:active {
            cursor: grabbing;
        }

        .info-panel {
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #cccccc;
        }

        .info-value {
            color: #ffffff;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .duration-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .duration-input {
            flex: 1;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        .duration-preset {
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .duration-preset:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .duration-preset.active {
            background: #4facfe;
            border-color: #4facfe;
        }

        .rotation-controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .rotation-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .rotation-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .rotation-btn.active {
            background: #4facfe;
            border-color: #4facfe;
        }

        .music-status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .status-success {
            border-left: 4px solid #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .status-warning {
            border-left: 4px solid #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .status-error {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .status-loading {
            border-left: 4px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .music-params {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .param-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 13px;
        }

        .param-label {
            color: #a0a0a0;
        }

        .param-value {
            color: #4facfe;
            font-weight: bold;
        }

        .enhanced-prompt {
            background: rgba(75, 85, 99, 0.3);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            color: #d1d5db;
            line-height: 1.4;
        }

        .enhanced-prompt .prompt-label {
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .duration-display {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 4px;
            padding: 4px 8px;
            display: inline-block;
            font-size: 11px;
            color: #60a5fa;
            margin-left: 8px;
        }

        .retry-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .retry-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .constellation-legend {
            font-size: 12px;
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
            color: #00ff00;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            backdrop-filter: blur(5px);
        }

        .status-indicator.error {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.5);
            color: #ff6b6b;
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin: 8px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
            width: 0%;
            transition: width 0.3s ease;
            animation: progressPulse 2s ease-in-out infinite;
        }

        @keyframes progressPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timeout-help {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #ffc107;
        }

        .help-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <div class="section-title">
                <i class="fas fa-star"></i>
                28æ˜Ÿå®¿å¤©ä½“æ˜Ÿå›¾
            </div>

            <div class="control-group">
                <label class="info-label">è§‚æµ‹æ—¶é—´</label>
                <input type="datetime-local" id="timeInput" class="w-full p-2 bg-gray-800 text-white border border-gray-600 rounded mt-2">
                <button id="updateBtn" class="btn btn-primary mt-2">æ›´æ–°æ˜Ÿå›¾</button>
            </div>

            <div class="control-group">
                <label class="info-label">éŸ³ä¹æ—¶é•¿è®¾ç½®</label>
                <div class="duration-control">
                    <input type="number" id="durationInput" class="duration-input" value="45" min="15" max="180" step="5">
                    <span class="text-xs text-gray-400">ç§’</span>
                </div>
                <div class="flex gap-1 mt-2">
                    <button class="duration-preset" data-duration="30">30s</button>
                    <button class="duration-preset active" data-duration="45">45s</button>
                    <button class="duration-preset" data-duration="60">60s</button>
                    <button class="duration-preset" data-duration="90">90s</button>
                </div>
                <div class="text-xs text-gray-400 mt-1">æ¨è45ç§’ï¼Œç”Ÿæˆæ›´å®Œæ•´çš„éŸ³ä¹ä½œå“</div>
            </div>

            <div class="control-group">
                <label class="info-label">æ—‹è½¬æ§åˆ¶</label>
                <div class="rotation-controls mt-2">
                    <button id="pauseBtn" class="rotation-btn active">æš‚åœ</button>
                    <button id="slowBtn" class="rotation-btn">æ…¢é€Ÿ</button>
                    <button id="normalBtn" class="rotation-btn">æ­£å¸¸</button>
                    <button id="fastBtn" class="rotation-btn">å¿«é€Ÿ</button>
                </div>
            </div>

            <div class="control-group">
                <label class="info-label">æ˜¾ç¤ºé€‰é¡¹</label>
                <div class="mt-2 space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="showLabels" checked class="mr-2">
                        <span>æ˜¾ç¤ºæ˜Ÿå®¿æ ‡æ³¨</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="showLines" checked class="mr-2">
                        <span>æ˜¾ç¤ºè¿çº¿</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="showBackground" checked class="mr-2">
                        <span>æ˜¾ç¤ºèƒŒæ™¯æ˜Ÿç©º</span>
                    </label>
                </div>
            </div>

            <div class="constellation-legend">
                <div class="section-title">å››è±¡å›¾ä¾‹</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4facfe;"></div>
                    <span>ä¸œæ–¹é’é¾™ (7å®¿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>å—æ–¹æœ±é›€ (7å®¿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffffff;"></div>
                    <span>è¥¿æ–¹ç™½è™ (7å®¿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #a8a8a8;"></div>
                    <span>åŒ—æ–¹ç„æ­¦ (7å®¿)</span>
                </div>
            </div>

            <button id="generateMusicBtn" class="btn btn-secondary">
                <i class="fas fa-music"></i> ç”ŸæˆéŸ³ä¹
            </button>
        </div>

        <!-- æ˜Ÿå›¾åŒºåŸŸ -->
        <div class="star-canvas-container">
            <canvas id="starCanvas"></canvas>
            <div class="status-indicator" id="statusIndicator">åˆå§‹åŒ–ä¸­...</div>
            <div class="loading" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <div id="loadingText">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- ä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
            <div class="section-title">
                <i class="fas fa-moon"></i>
                å¤©æ–‡ä¿¡æ¯
            </div>
            <div class="info-item">
                <span class="info-label">å½“å‰æ—¶é—´:</span>
                <span class="info-value" id="currentTime">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">æœˆäº®æ˜Ÿå®¿:</span>
                <span class="info-value" id="moonMansion">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">å¯¹åº”äº”è¡Œ:</span>
                <span class="info-value" id="element">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">é»„ç»åº¦æ•°:</span>
                <span class="info-value" id="eclipticLon">--Â°</span>
            </div>

            <div class="section-title mt-6">
                <i class="fas fa-music"></i>
                éŸ³ä¹å‚æ•°
                <span class="duration-display" id="durationDisplay">45ç§’</span>
            </div>
            <div class="info-item">
                <span class="info-label">ä¹å™¨:</span>
                <span class="info-value" id="instrument">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">è°ƒå¼:</span>
                <span class="info-value" id="mode">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">é£æ ¼:</span>
                <span class="info-value">cinematic, ethereal</span>
            </div>

            <div class="section-title mt-6">
                <i class="fas fa-play"></i>
                éŸ³ä¹æ’­æ”¾å™¨
            </div>
            
            <div id="musicStatusContainer">
                <div class="music-status-card status-loading" id="musicStatusCard">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-info-circle"></i>
                        <span class="font-bold">å‡†å¤‡ç”ŸæˆéŸ³ä¹</span>
                    </div>
                    <div id="musicStatusText">ç‚¹å‡»"ç”ŸæˆéŸ³ä¹"æŒ‰é’®å¼€å§‹</div>
                </div>
            </div>

            <div id="musicParamsDisplay" style="display: none;">
                <div class="music-params">
                    <div class="param-item">
                        <span class="param-label">æ˜Ÿå®¿:</span>
                        <span class="param-value" id="paramMansion">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">äº”è¡Œ:</span>
                        <span class="param-value" id="paramElement">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">ä¹å™¨:</span>
                        <span class="param-value" id="paramInstrument">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">è°ƒå¼:</span>
                        <span class="param-value" id="paramMode">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">æ—¶é•¿:</span>
                        <span class="param-value" id="paramDuration">--</span>
                    </div>
                </div>
            </div>

            <div id="enhancedPromptDisplay" style="display: none;">
                <div class="enhanced-prompt">
                    <span class="prompt-label">
                        <i class="fas fa-magic"></i> å¢å¼ºæç¤ºè¯ï¼š
                    </span>
                    <div id="enhancedPromptText">--</div>
                </div>
            </div>

            <audio id="musicPlayer" controls class="w-full mt-3" style="display: none;"></audio>
            
            <div id="retrySection" style="display: none;">
                <div class="retry-options">
                    <button id="retryBtn" class="retry-btn btn-warning">
                        <i class="fas fa-redo"></i> é‡è¯•
                    </button>
                    <button id="forceRetryBtn" class="retry-btn btn-primary">
                        <i class="fas fa-bolt"></i> å¼ºåˆ¶é‡è¯•
                    </button>
                </div>
                <div class="timeout-help mt-3">
                    <div class="help-title">
                        <i class="fas fa-lightbulb"></i>
                        é‡åˆ°è¶…æ—¶é—®é¢˜ï¼Ÿ
                    </div>
                    <div>â€¢ å¤–éƒ¨éŸ³ä¹æœåŠ¡å¯èƒ½ç¹å¿™</div>
                    <div>â€¢ è¾ƒé•¿æ—¶é•¿çš„éŸ³ä¹éœ€è¦æ›´å¤šç”Ÿæˆæ—¶é—´</div>
                    <div>â€¢ å¤©æ–‡è®¡ç®—å·²å®Œæˆï¼Œåªéœ€é‡æ–°ç”ŸæˆéŸ³é¢‘</div>
                </div>
            </div>

            <div id="downloadSection" style="display: none;" class="mt-4">
                <button id="downloadMusic" class="btn btn-success mb-2">
                    <i class="fas fa-download"></i> ä¸‹è½½éŸ³ä¹
                </button>
                <button id="downloadSheet" class="btn btn-success">
                    <i class="fas fa-file-pdf"></i> ä¸‹è½½ä¹è°±
                </button>
            </div>
        </div>
    </div>

    <!-- å¤šä¸ªCDNå¤‡ç”¨æ–¹æ¡ˆ -->
    <script>
        (function() {
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
                'https://unpkg.com/three@0.128.0/build/three.min.js'
            ];

            let currentCDN = 0;

            function loadThreeJS() {
                if (currentCDN >= cdnSources.length) {
                    console.error('æ‰€æœ‰Three.js CDNéƒ½åŠ è½½å¤±è´¥');
                    document.getElementById('statusIndicator').textContent = 'Three.jsåŠ è½½å¤±è´¥';
                    document.getElementById('statusIndicator').className = 'status-indicator error';
                    return;
                }

                const script = document.createElement('script');
                script.src = cdnSources[currentCDN];
                script.onload = function() {
                    console.log('Three.jsåŠ è½½æˆåŠŸ:', cdnSources[currentCDN]);
                    initStarMap();
                };
                script.onerror = function() {
                    console.warn('CDNå¤±è´¥:', cdnSources[currentCDN]);
                    currentCDN++;
                    loadThreeJS();
                };
                document.head.appendChild(script);
            }

            loadThreeJS();
        })();

        // æ˜Ÿå®¿æ•°æ®
        const CONSTELLATION_DATA = {
            // ä¸œæ–¹é’é¾™ä¸ƒå®¿
            "è§’": {
                color: "#4facfe",
                stars: [
                    {name: "è§’å®¿ä¸€", ra: 201.298, dec: -11.161, mag: 0.97},
                    {name: "è§’å®¿äºŒ", ra: 213.915, dec: -0.596, mag: 3.38},
                    {name: "è§’å®¿ä¸‰", ra: 201.5, dec: -10.5, mag: 4.2}
                ],
                connections: [[0,1], [1,2], [2,0]]
            },
            "äº¢": {
                color: "#4facfe",
                stars: [
                    {name: "äº¢å®¿ä¸€", ra: 215.676, dec: -9.383, mag: 4.16},
                    {name: "äº¢å®¿äºŒ", ra: 218.877, dec: -12.848, mag: 4.07},
                    {name: "äº¢å®¿ä¸‰", ra: 220.5, dec: -10.2, mag: 4.5},
                    {name: "äº¢å®¿å››", ra: 216.8, dec: -8.9, mag: 5.1}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0]]
            },
            "å¿ƒ": {
                color: "#4facfe",
                stars: [
                    {name: "å¿ƒå®¿ä¸€", ra: 243.587, dec: -28.216, mag: 2.89},
                    {name: "å¿ƒå®¿äºŒ", ra: 247.352, dec: -26.432, mag: 0.96},
                    {name: "å¿ƒå®¿ä¸‰", ra: 245.297, dec: -25.592, mag: 2.70}
                ],
                connections: [[0,1], [1,2]]
            },
            // å—æ–¹æœ±é›€ä¸ƒå®¿
            "äº•": {
                color: "#ff6b6b",
                stars: [
                    {name: "äº•å®¿ä¸€", ra: 93.719, dec: 22.514, mag: 3.53},
                    {name: "äº•å®¿äºŒ", ra: 95.241, dec: 22.964, mag: 4.45},
                    {name: "äº•å®¿ä¸‰", ra: 93.506, dec: 24.398, mag: 3.35},
                    {name: "äº•å®¿å››", ra: 92.946, dec: 21.982, mag: 4.97}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0], [0,2], [1,3]]
            },
            "é¬¼": {
                color: "#ff6b6b",
                stars: [
                    {name: "é¬¼å®¿ä¸€", ra: 130.821, dec: 19.841, mag: 3.94},
                    {name: "é¬¼å®¿äºŒ", ra: 131.171, dec: 21.469, mag: 4.67},
                    {name: "é¬¼å®¿ä¸‰", ra: 130.109, dec: 20.569, mag: 4.02},
                    {name: "é¬¼å®¿å››", ra: 129.886, dec: 18.154, mag: 4.26}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0]]
            },
            // è¥¿æ–¹ç™½è™ä¸ƒå®¿
            "æ˜´": {
                color: "#ffffff",
                stars: [
                    {name: "æ˜´å®¿ä¸€", ra: 56.871, dec: 24.105, mag: 5.65},
                    {name: "æ˜´å®¿äºŒ", ra: 57.290, dec: 24.367, mag: 4.30},
                    {name: "æ˜´å®¿ä¸‰", ra: 56.217, dec: 24.283, mag: 4.18},
                    {name: "æ˜´å®¿å››", ra: 56.456, dec: 24.011, mag: 5.45},
                    {name: "æ˜´å®¿äº”", ra: 56.530, dec: 24.498, mag: 5.76},
                    {name: "æ˜´å®¿å…­", ra: 57.297, dec: 24.052, mag: 4.62},
                    {name: "æ˜´å®¿ä¸ƒ", ra: 65.734, dec: 25.948, mag: 4.14}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6], [6,0], [0,3], [1,4], [2,5]]
            },
            "å‚": {
                color: "#ffffff",
                stars: [
                    {name: "å‚å®¿ä¸€", ra: 85.190, dec: -1.202, mag: 1.70},
                    {name: "å‚å®¿äºŒ", ra: 84.053, dec: -1.944, mag: 2.23},
                    {name: "å‚å®¿ä¸‰", ra: 83.858, dec: -5.910, mag: 2.25},
                    {name: "å‚å®¿å››", ra: 88.793, dec: 7.407, mag: 0.45},
                    {name: "å‚å®¿äº”", ra: 84.411, dec: -1.201, mag: 2.77},
                    {name: "å‚å®¿å…­", ra: 82.061, dec: -0.180, mag: 2.09},
                    {name: "å‚å®¿ä¸ƒ", ra: 81.283, dec: 6.350, mag: 1.64}
                ],
                connections: [[0,1], [1,2], [3,4], [4,5], [5,6], [6,3]]
            },
            // åŒ—æ–¹ç„æ­¦ä¸ƒå®¿
            "æ–—": {
                color: "#a8a8a8",
                stars: [
                    {name: "æ–—å®¿ä¸€", ra: 278.110, dec: -25.421, mag: 3.17},
                    {name: "æ–—å®¿äºŒ", ra: 279.234, dec: -26.297, mag: 2.81},
                    {name: "æ–—å®¿ä¸‰", ra: 285.653, dec: -29.828, mag: 3.93},
                    {name: "æ–—å®¿å››", ra: 290.660, dec: -30.424, mag: 2.60},
                    {name: "æ–—å®¿äº”", ra: 296.565, dec: -29.578, mag: 3.89},
                    {name: "æ–—å®¿å…­", ra: 298.969, dec: -26.684, mag: 2.02}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5]]
            },
            "ç‰›": {
                color: "#a8a8a8",
                stars: [
                    {name: "ç‰›å®¿ä¸€", ra: 304.413, dec: -12.759, mag: 3.08},
                    {name: "ç‰›å®¿äºŒ", ra: 308.300, dec: -17.847, mag: 4.28},
                    {name: "ç‰›å®¿ä¸‰", ra: 311.553, dec: -17.233, mag: 4.51},
                    {name: "ç‰›å®¿å››", ra: 307.372, dec: -24.779, mag: 4.07},
                    {name: "ç‰›å®¿äº”", ra: 309.387, dec: -14.781, mag: 4.48},
                    {name: "ç‰›å®¿å…­", ra: 314.293, dec: -18.299, mag: 4.11}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,0]]
            }
        };

        let scene, camera, renderer, starField, rotationSpeed = 0;
        let constellationGroups = [];
        let isRotating = false;
        let currentData = null;
        let retryCount = 0;
        let maxRetries = 3;

        function initStarMap() {
            try {
                if (typeof THREE === 'undefined') {
                    throw new Error('THREE.jsæœªå®šä¹‰');
                }

                const canvas = document.getElementById('starCanvas');
                const container = canvas.parentElement;

                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setClearColor(0x000011, 1);

                // åˆ›å»ºæ˜Ÿç©ºèƒŒæ™¯
                createBackgroundStars();
                
                // åˆ›å»ºæ˜Ÿå®¿ç¾¤ç»„
                createConstellationGroups();

                // è®¾ç½®ç›¸æœºä½ç½®
                camera.position.set(0, 0, 150);

                // è®¾ç½®äº‹ä»¶ç›‘å¬
                setupEventListeners();
                
                // å¼€å§‹åŠ¨ç”»å¾ªç¯
                animate();

                // åˆå§‹åŒ–æ—¶é—´å’Œæ•°æ®
                setCurrentTime();
                updateAstronomyData();

                document.getElementById('statusIndicator').textContent = 'æ˜Ÿå›¾åŠ è½½å®Œæˆ';

            } catch (error) {
                console.error('æ˜Ÿå›¾åˆå§‹åŒ–å¤±è´¥:', error);
                document.getElementById('statusIndicator').textContent = 'åˆå§‹åŒ–å¤±è´¥: ' + error.message;
                document.getElementById('statusIndicator').className = 'status-indicator error';
            }
        }

        function createBackgroundStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 2000;
            const positions = new Float32Array(starCount * 3);
            const colors = new Float32Array(starCount * 3);

            for (let i = 0; i < starCount; i++) {
                const radius = 80;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = radius * Math.cos(phi);
                
                const brightness = Math.random() * 0.8 + 0.2;
                colors[i * 3] = brightness;
                colors[i * 3 + 1] = brightness;
                colors[i * 3 + 2] = brightness;
            }

            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const starMaterial = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.6
            });

            starField = new THREE.Points(starGeometry, starMaterial);
            scene.add(starField);
        }

        function createConstellationGroups() {
            Object.entries(CONSTELLATION_DATA).forEach(([name, data]) => {
                const group = new THREE.Group();
                group.name = name;

                // åˆ›å»ºæ˜Ÿå®¿ä¸­çš„æ˜Ÿæ˜Ÿ
                const starMeshes = [];
                data.stars.forEach((star, index) => {
                    const position = sphericalToCartesian(star.ra, star.dec, 90);
                    
                    // æ ¹æ®æ˜Ÿç­‰è®¾ç½®å¤§å°
                    const size = Math.max(0.3, (6 - star.mag) * 0.3);
                    const starGeometry = new THREE.SphereGeometry(size, 8, 8);
                    const starMaterial = new THREE.MeshBasicMaterial({ 
                        color: new THREE.Color(data.color),
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    const starMesh = new THREE.Mesh(starGeometry, starMaterial);
                    starMesh.position.copy(position);
                    starMesh.userData = { name: star.name, magnitude: star.mag };
                    
                    group.add(starMesh);
                    starMeshes.push(starMesh);
                });

                // åˆ›å»ºè¿çº¿
                if (data.connections && data.connections.length > 0) {
                    const lineGeometry = new THREE.BufferGeometry();
                    const positions = [];
                    
                    data.connections.forEach(connection => {
                        const start = starMeshes[connection[0]].position;
                        const end = starMeshes[connection[1]].position;
                        positions.push(start.x, start.y, start.z);
                        positions.push(end.x, end.y, end.z);
                    });
                    
                    lineGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                    
                    const lineMaterial = new THREE.LineBasicMaterial({
                        color: new THREE.Color(data.color),
                        transparent: true,
                        opacity: 0.6,
                        linewidth: 2
                    });
                    
                    const lines = new THREE.LineSegments(lineGeometry, lineMaterial);
                    group.add(lines);
                }

                // åˆ›å»ºæ ‡ç­¾
                const labelCanvas = document.createElement('canvas');
                labelCanvas.width = 128;
                labelCanvas.height = 64;
                const ctx = labelCanvas.getContext('2d');
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, 128, 64);
                ctx.fillStyle = data.color;
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(name + 'å®¿', 64, 35);
                
                const labelTexture = new THREE.CanvasTexture(labelCanvas);
                const labelMaterial = new THREE.MeshBasicMaterial({ 
                    map: labelTexture, 
                    transparent: true 
                });
                const labelGeometry = new THREE.PlaneGeometry(8, 4);
                const labelMesh = new THREE.Mesh(labelGeometry, labelMaterial);
                
                // è®¡ç®—æ˜Ÿå®¿ä¸­å¿ƒä½ç½®
                const centerPosition = new THREE.Vector3();
                starMeshes.forEach(star => centerPosition.add(star.position));
                centerPosition.divideScalar(starMeshes.length);
                centerPosition.normalize().multiplyScalar(95);
                
                labelMesh.position.copy(centerPosition);
                group.add(labelMesh);

                scene.add(group);
                constellationGroups.push(group);
            });
        }

        function sphericalToCartesian(ra, dec, radius) {
            const phi = (90 - dec) * Math.PI / 180;
            const theta = ra * Math.PI / 180;
            
            return new THREE.Vector3(
                radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        function setupEventListeners() {
            const canvas = document.getElementById('starCanvas');
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            // é¼ æ ‡æ§åˆ¶
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };

                    scene.rotation.y += deltaMove.x * 0.01;
                    scene.rotation.x += deltaMove.y * 0.01;

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // æ»šè½®ç¼©æ”¾
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoom = e.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(zoom);
                
                const distance = camera.position.length();
                if (distance < 50) camera.position.normalize().multiplyScalar(50);
                if (distance > 300) camera.position.normalize().multiplyScalar(300);
            });

            // æ—¶é•¿æ§åˆ¶
            const durationInput = document.getElementById('durationInput');
            const durationDisplay = document.getElementById('durationDisplay');
            
            durationInput.addEventListener('input', (e) => {
                const duration = parseInt(e.target.value);
                durationDisplay.textContent = `${duration}ç§’`;
                updateDurationPresets(duration);
            });

            // æ—¶é•¿é¢„è®¾æŒ‰é’®
            document.querySelectorAll('.duration-preset').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const duration = parseInt(e.target.dataset.duration);
                    durationInput.value = duration;
                    durationDisplay.textContent = `${duration}ç§’`;
                    updateDurationPresets(duration);
                });
            });

            // æ—‹è½¬æ§åˆ¶æŒ‰é’®
            document.getElementById('pauseBtn').addEventListener('click', () => setRotationSpeed(0));
            document.getElementById('slowBtn').addEventListener('click', () => setRotationSpeed(0.001));
            document.getElementById('normalBtn').addEventListener('click', () => setRotationSpeed(0.005));
            document.getElementById('fastBtn').addEventListener('click', () => setRotationSpeed(0.02));

            // å…¶ä»–æ§ä»¶
            document.getElementById('updateBtn').addEventListener('click', updateAstronomyData);
            document.getElementById('generateMusicBtn').addEventListener('click', generateMusic);

            // é‡è¯•æŒ‰é’®
            document.getElementById('retryBtn').addEventListener('click', () => retryMusic(false));
            document.getElementById('forceRetryBtn').addEventListener('click', () => retryMusic(true));

            // æ˜¾ç¤ºé€‰é¡¹
            document.getElementById('showLabels').addEventListener('change', toggleLabels);
            document.getElementById('showLines').addEventListener('change', toggleLines);
            document.getElementById('showBackground').addEventListener('change', toggleBackground);

            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                const container = canvas.parentElement;
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function updateDurationPresets(activeDuration) {
            document.querySelectorAll('.duration-preset').forEach(btn => {
                const btnDuration = parseInt(btn.dataset.duration);
                btn.classList.toggle('active', btnDuration === activeDuration);
            });
        }

        function setRotationSpeed(speed) {
            rotationSpeed = speed;
            isRotating = speed > 0;

            document.querySelectorAll('.rotation-btn').forEach(btn => btn.classList.remove('active'));
            
            if (speed === 0) document.getElementById('pauseBtn').classList.add('active');
            else if (speed === 0.001) document.getElementById('slowBtn').classList.add('active');
            else if (speed === 0.005) document.getElementById('normalBtn').classList.add('active');
            else if (speed === 0.02) document.getElementById('fastBtn').classList.add('active');
        }

        function toggleLabels(e) {
            constellationGroups.forEach(group => {
                const labels = group.children.filter(child => child.type === 'Mesh' && child.material.map);
                labels.forEach(label => label.visible = e.target.checked);
            });
        }

        function toggleLines(e) {
            constellationGroups.forEach(group => {
                const lines = group.children.filter(child => child.type === 'LineSegments');
                lines.forEach(line => line.visible = e.target.checked);
            });
        }

        function toggleBackground(e) {
            if (starField) starField.visible = e.target.checked;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRotating) {
                scene.rotation.y += rotationSpeed;
            }

            // æ ‡ç­¾å§‹ç»ˆé¢å‘ç›¸æœº
            constellationGroups.forEach(group => {
                const labels = group.children.filter(child => child.type === 'Mesh' && child.material.map);
                labels.forEach(label => label.lookAt(camera.position));
            });

            renderer.render(scene, camera);
        }

        function setCurrentTime() {
            const now = new Date();
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('timeInput').value = timeString;
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        async function updateAstronomyData() {
            try {
                const timeInput = document.getElementById('timeInput').value;
                const params = new URLSearchParams();
                if (timeInput) params.append('date', timeInput);

                const response = await fetch(`/api/mansion?${params}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                if (!data.success) throw new Error(data.error || 'è·å–æ•°æ®å¤±è´¥');

                currentData = data;
                updateUI(data);
                highlightMoonMansion(data.mansion);

            } catch (error) {
                console.error('æ›´æ–°å¤©æ–‡æ•°æ®å¤±è´¥:', error);
                showMusicStatus('error', 'æ•°æ®æ›´æ–°å¤±è´¥', error.message);
            }
        }

        function updateUI(data) {
            document.getElementById('currentTime').textContent = new Date(data.timestamp).toLocaleString('zh-CN');
            document.getElementById('moonMansion').textContent = data.mansion + 'å®¿';
            document.getElementById('element').textContent = data.element;
            document.getElementById('eclipticLon').textContent = data.moon_ecliptic_lon.toFixed(2) + 'Â°';
            document.getElementById('instrument').textContent = data.instrument;
            document.getElementById('mode').textContent = data.mode;
        }

        function highlightMoonMansion(mansion) {
            constellationGroups.forEach(group => {
                const isCurrentMansion = group.name === mansion;
                group.children.forEach(child => {
                    if (child.material) {
                        if (isCurrentMansion) {
                            child.material.opacity = 1.0;
                            if (child.material.emissive) {
                                child.material.emissive.setHex(0x331100);
                            }
                        } else {
                            child.material.opacity = 0.6;
                            if (child.material.emissive) {
                                child.material.emissive.setHex(0x000000);
                            }
                        }
                    }
                });
            });
        }

        async function generateMusic() {
            if (!currentData) {
                showMusicStatus('error', 'è¯·å…ˆæ›´æ–°å¤©æ–‡æ•°æ®', 'éœ€è¦å…ˆè·å–å¤©æ–‡ä¿¡æ¯æ‰èƒ½ç”ŸæˆéŸ³ä¹');
                return;
            }

            const generateBtn = document.getElementById('generateMusicBtn');
            const originalText = generateBtn.innerHTML;
            const duration = parseInt(document.getElementById('durationInput').value);
            
            try {
                // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
                generateBtn.disabled = true;
                
                showMusicStatus('loading', `æ­£åœ¨ç”Ÿæˆ${duration}ç§’éŸ³ä¹...`, 'æ­£åœ¨è®¡ç®—å¤©æ–‡å‚æ•°å¹¶è°ƒç”¨éŸ³ä¹ç”ŸæˆæœåŠ¡');
                showLoadingIndicator(true, `ç”Ÿæˆ${duration}ç§’éŸ³ä¹ä¸­...`);
                
                const requestData = {
                    date: document.getElementById('timeInput').value,
                    lat: 22.3964,
                    lon: 114.1095,
                    style: 'cinematic, ethereal',
                    duration: duration
                };
                
                console.log('å‘é€éŸ³ä¹ç”Ÿæˆè¯·æ±‚:', requestData);
                
                const response = await fetch('/api/generate_music', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('æ”¶åˆ°éŸ³ä¹ç”Ÿæˆå“åº”:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'éŸ³ä¹ç”Ÿæˆå¤±è´¥');
                }

                handleMusicResult(result);

            } catch (error) {
                console.error('éŸ³ä¹ç”Ÿæˆå¤±è´¥:', error);
                showMusicStatus('error', 'éŸ³ä¹ç”Ÿæˆå¤±è´¥', error.message);
                retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
                showRetryOptions(true);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                showLoadingIndicator(false);
            }
        }

        function handleMusicResult(result) {
            console.log('å¤„ç†éŸ³ä¹ç»“æœ:', result);

            // æ˜¾ç¤ºéŸ³ä¹å‚æ•°
            if (result.parameters) {
                showMusicParams(result.astronomy, result.parameters);
                
                // æ˜¾ç¤ºå¢å¼ºæç¤ºè¯
                if (result.parameters.enhanced_prompt) {
                    showEnhancedPrompt(result.parameters.enhanced_prompt);
                }
            }

            // æ£€æŸ¥éŸ³ä¹ç”Ÿæˆæ˜¯å¦æˆåŠŸ
            if (result.music && result.music.download_url && result.music.success !== false) {
                // éŸ³ä¹ç”ŸæˆæˆåŠŸ
                const duration = result.parameters?.duration || 45;
                showMusicStatus('success', `${duration}ç§’éŸ³ä¹ç”ŸæˆæˆåŠŸï¼`, 'æ­£åœ¨åŠ è½½éŸ³é¢‘æ–‡ä»¶...');
                loadAndPlayAudio(result.music.download_url, result.music.pdf_download_url);
                showRetryOptions(false);
                
            } else if (result.music && result.music.success === false) {
                // éŸ³ä¹ç”Ÿæˆå¤±è´¥ï¼Œä½†å¤©æ–‡è®¡ç®—æˆåŠŸ
                const errorMsg = result.music.error || 'å¤–éƒ¨éŸ³ä¹æœåŠ¡è¶…æ—¶';
                const duration = result.parameters?.duration || 45;
                showMusicStatus('warning', `${duration}ç§’éŸ³ä¹å‚æ•°ç”ŸæˆæˆåŠŸ`, 
                    `å¤©æ–‡è®¡ç®—å·²å®Œæˆï¼Œä½†éŸ³é¢‘ç”Ÿæˆå¤±è´¥ï¼š${errorMsg}`);
                showRetryOptions(true);
                
            } else {
                // æ— éŸ³ä¹æ•°æ®
                const duration = result.parameters?.duration || 45;
                showMusicStatus('warning', `${duration}ç§’éŸ³ä¹å‚æ•°ç”ŸæˆæˆåŠŸ`, 
                    'å¤©æ–‡æ•°æ®è®¡ç®—å®Œæˆï¼Œä½†éŸ³é¢‘æ–‡ä»¶ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•');
                showRetryOptions(true);
            }
        }

        function showMusicParams(astronomy, parameters) {
            document.getElementById('paramMansion').textContent = astronomy.mansion + 'å®¿';
            document.getElementById('paramElement').textContent = parameters.element;
            document.getElementById('paramInstrument').textContent = parameters.instrument;
            document.getElementById('paramMode').textContent = parameters.mode;
            document.getElementById('paramDuration').textContent = (parameters.duration || 45) + 'ç§’';
            document.getElementById('musicParamsDisplay').style.display = 'block';
        }

        function showEnhancedPrompt(prompt) {
            document.getElementById('enhancedPromptText').textContent = prompt;
            document.getElementById('enhancedPromptDisplay').style.display = 'block';
        }

        async function loadAndPlayAudio(audioUrl, pdfUrl = null) {
            const player = document.getElementById('musicPlayer');
            
            try {
                showMusicStatus('loading', 'åŠ è½½éŸ³é¢‘æ–‡ä»¶...', 'æ­£åœ¨ä»æœåŠ¡å™¨åŠ è½½éŸ³ä¹æ–‡ä»¶');
                
                // æ˜¾ç¤ºæ’­æ”¾å™¨
                player.style.display = 'block';
                player.src = audioUrl;
                
                // æ·»åŠ éŸ³é¢‘äº‹ä»¶ç›‘å¬å™¨
                player.onloadstart = () => {
                    showMusicStatus('loading', 'æ­£åœ¨åŠ è½½éŸ³é¢‘...', 'éŸ³é¢‘æ–‡ä»¶å¼€å§‹ä¸‹è½½');
                };
                
                player.oncanplay = () => {
                    showMusicStatus('success', 'éŸ³é¢‘åŠ è½½å®Œæˆ', 'å¯ä»¥å¼€å§‹æ’­æ”¾éŸ³ä¹');
                };
                
                player.onplaying = () => {
                    showMusicStatus('success', 'æ­£åœ¨æ’­æ”¾éŸ³ä¹ ğŸµ', 'äº«å—ç”±æ˜Ÿå®¿ç”Ÿæˆçš„ç¾å¦™éŸ³ä¹');
                };
                
                player.onpause = () => {
                    showMusicStatus('success', 'éŸ³ä¹å·²æš‚åœ', 'ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç»§ç»­');
                };
                
                player.onended = () => {
                    showMusicStatus('success', 'æ’­æ”¾å®Œæˆ', 'éŸ³ä¹æ’­æ”¾ç»“æŸ');
                };
                
                player.onerror = (e) => {
                    console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                    showMusicStatus('error', 'éŸ³é¢‘æ’­æ”¾å¤±è´¥', 
                        `é”™è¯¯ä»£ç : ${player.error ? player.error.code : 'æœªçŸ¥'}`);
                    showRetryOptions(true);
                };
                
                // è®¾ç½®ä¸‹è½½æŒ‰é’®
                setupDownloadButtons(audioUrl, pdfUrl);
                
                // å°è¯•è‡ªåŠ¨æ’­æ”¾
                try {
                    await player.play();
                    showMusicStatus('success', 'è‡ªåŠ¨æ’­æ”¾å·²å¼€å§‹ ğŸµ', 'æ­£åœ¨æ’­æ”¾æ ¹æ®æ˜Ÿå®¿ç”Ÿæˆçš„éŸ³ä¹');
                } catch (autoplayError) {
                    console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', autoplayError);
                    showMusicStatus('success', 'éŸ³é¢‘å·²å°±ç»ª', 'ç”±äºæµè§ˆå™¨ç­–ç•¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®');
                }
                
            } catch (error) {
                console.error('éŸ³é¢‘å¤„ç†å¤±è´¥:', error);
                showMusicStatus('error', 'éŸ³é¢‘å¤„ç†å¤±è´¥', error.message);
                showRetryOptions(true);
            }
        }

        function setupDownloadButtons(audioUrl, pdfUrl) {
            const downloadSection = document.getElementById('downloadSection');
            const downloadMusic = document.getElementById('downloadMusic');
            const downloadSheet = document.getElementById('downloadSheet');
            
            if (audioUrl) {
                downloadMusic.onclick = () => {
                    const link = document.createElement('a');
                    link.href = audioUrl;
                    link.download = `æ˜Ÿå®¿éŸ³ä¹_${new Date().getTime()}.mp3`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                downloadMusic.style.display = 'block';
            }
            
            if (pdfUrl) {
                downloadSheet.onclick = () => {
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    link.download = `æ˜Ÿå®¿ä¹è°±_${new Date().getTime()}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                downloadSheet.style.display = 'block';
            }
            
            if (audioUrl || pdfUrl) {
                downloadSection.style.display = 'block';
            }
        }

        function showMusicStatus(type, title, description) {
            const card = document.getElementById('musicStatusCard');
            const statusText = document.getElementById('musicStatusText');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            card.className = 'music-status-card';
            
            // æ·»åŠ å¯¹åº”çŠ¶æ€ç±»
            card.classList.add(`status-${type}`);
            
            // è®¾ç½®å›¾æ ‡
            let icon;
            switch (type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'error':
                    icon = 'fas fa-times-circle';
                    break;
                case 'loading':
                    icon = 'fas fa-spinner fa-spin';
                    break;
                default:
                    icon = 'fas fa-info-circle';
            }
            
            // æ›´æ–°å†…å®¹
            card.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <i class="${icon}"></i>
                    <span class="font-bold">${title}</span>
                </div>
                <div id="musicStatusText">${description}</div>
            `;
        }

        function showRetryOptions(show) {
            const retrySection = document.getElementById('retrySection');
            retrySection.style.display = show ? 'block' : 'none';
            
            if (show) {
                // æ›´æ–°é‡è¯•æŒ‰é’®çŠ¶æ€
                const retryBtn = document.getElementById('retryBtn');
                const forceRetryBtn = document.getElementById('forceRetryBtn');
                
                retryBtn.innerHTML = `<i class="fas fa-redo"></i> é‡è¯• (${retryCount + 1}/${maxRetries})`;
                
                if (retryCount >= maxRetries - 1) {
                    retryBtn.disabled = true;
                    forceRetryBtn.innerHTML = '<i class="fas fa-bolt"></i> å¼ºåˆ¶é‡è¯•';
                }
            }
        }

        async function retryMusic(force = false) {
            if (!force && retryCount >= maxRetries) {
                showMusicStatus('error', 'é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™', 'è¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return;
            }
            
            if (!force) {
                retryCount++;
            } else {
                retryCount = 0; // å¼ºåˆ¶é‡è¯•æ—¶é‡ç½®è®¡æ•°
            }
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
            const waitTime = force ? 1000 : (retryCount * 2000);
            const duration = parseInt(document.getElementById('durationInput').value);
            showMusicStatus('loading', 'å‡†å¤‡é‡è¯•...', `ç­‰å¾… ${waitTime/1000} ç§’åé‡æ–°ç”Ÿæˆ${duration}ç§’éŸ³ä¹`);
            
            setTimeout(() => {
                generateMusic();
            }, waitTime);
        }

        function showLoadingIndicator(show, text = 'åŠ è½½ä¸­...') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = text;
                loadingIndicator.style.display = 'block';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>