<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>28星宿音乐生成器 - 星图音乐生成</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0a0a23 0%, #1a1a3a 50%, #2a1a4a 100%);
            color: #ffffff;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            overflow: hidden;
        }

        /* 步骤导航样式 */
        .step-navigation {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 30px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 15px;
        }

        .step:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .step-number {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 5px;
            transition: all 0.3s ease;
        }

        .step-label {
            font-size: 12px;
            color: #cccccc;
        }

        .step.completed .step-number {
            background: #4ade80;
            color: #000000;
        }

        .step.active .step-number {
            background: #3b82f6;
            color: #ffffff;
        }

        .step.inactive .step-number {
            background: rgba(255, 255, 255, 0.2);
            color: #888888;
        }

        .step.active .step-label {
            color: #3b82f6;
        }

        .step-connector {
            width: 30px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            align-self: center;
            margin-top: 17px;
        }

        .main-container {
            display: flex;
            height: 100vh;
            padding-top: 80px;
        }

        .control-panel {
            width: 280px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .star-canvas-container {
            flex: 1;
            position: relative;
        }

        #starCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #starCanvas:active {
            cursor: grabbing;
        }

        .info-panel {
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            overflow-y: auto;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #4facfe;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: #cccccc;
        }

        .info-value {
            color: #ffffff;
            font-weight: bold;
        }

        /* 已选择信息卡片 */
        .selected-info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .selected-info-title {
            font-size: 14px;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .selected-info-content {
            font-size: 12px;
            color: #cccccc;
            line-height: 1.4;
        }

        .btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9a56 0%, #ff6b35 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #cccccc;
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .duration-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .duration-input {
            flex: 1;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
        }

        .duration-preset {
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        .duration-preset:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .duration-preset.active {
            background: #4facfe;
            border-color: #4facfe;
        }

        .rotation-controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .rotation-btn {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .rotation-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .rotation-btn.active {
            background: #4facfe;
            border-color: #4facfe;
        }

        .music-status-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .status-success {
            border-left: 4px solid #4ade80;
            background: rgba(74, 222, 128, 0.1);
        }

        .status-warning {
            border-left: 4px solid #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .status-error {
            border-left: 4px solid #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .status-loading {
            border-left: 4px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .music-params {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .param-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 13px;
        }

        .param-label {
            color: #a0a0a0;
        }

        .param-value {
            color: #4facfe;
            font-weight: bold;
        }

        .enhanced-prompt {
            background: rgba(75, 85, 99, 0.3);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 11px;
            color: #d1d5db;
            line-height: 1.4;
        }

        .enhanced-prompt .prompt-label {
            color: #fbbf24;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .duration-display {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 4px;
            padding: 4px 8px;
            display: inline-block;
            font-size: 11px;
            color: #60a5fa;
            margin-left: 8px;
        }

        .retry-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .retry-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .constellation-legend {
            font-size: 12px;
            margin-bottom: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid rgba(0, 255, 0, 0.5);
            color: #00ff00;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 12px;
            backdrop-filter: blur(5px);
        }

        .status-indicator.error {
            background: rgba(255, 0, 0, 0.2);
            border-color: rgba(255, 0, 0, 0.5);
            color: #ff6b6b;
        }

        .timeout-help {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #ffc107;
        }

        .help-title {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 数据缺失警告 */
        .data-missing-warning {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #fca5a5;
        }

        .data-missing-warning .warning-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-missing-warning .warning-text {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- 步骤导航 -->
    <div class="step-navigation">
        <div class="step completed" onclick="goBackToStep(1)">
            <div class="step-number">1</div>
            <div class="step-label">时间选择</div>
        </div>
        <div class="step-connector"></div>
        <div class="step completed" onclick="goBackToStep(2)">
            <div class="step-number">2</div>
            <div class="step-label">位置选择</div>
        </div>
        <div class="step-connector"></div>
        <div class="step active">
            <div class="step-number">3</div>
            <div class="step-label">星图音乐</div>
        </div>
    </div>

    <div class="main-container">
        <!-- 控制面板 -->
        <div class="control-panel">
            <div class="section-title">
                <i class="fas fa-star"></i>
                28星宿天体星图
            </div>

            <!-- 已选择信息显示 -->
            <div id="selectedInfoContainer">
                <!-- 时间信息卡片 -->
                <div class="selected-info-card">
                    <div class="selected-info-title">
                        <i class="fas fa-clock"></i>
                        已选择时间
                    </div>
                    <div class="selected-info-content" id="selectedTimeInfo">
                        正在读取选择的时间...
                    </div>
                </div>

                <!-- 位置信息卡片 -->
                <div class="selected-info-card">
                    <div class="selected-info-title">
                        <i class="fas fa-map-marker-alt"></i>
                        观测位置
                    </div>
                    <div class="selected-info-content" id="selectedLocationInfo">
                        正在读取选择的位置...
                    </div>
                </div>

                <!-- 数据缺失警告 -->
                <div id="dataMissingWarning" class="data-missing-warning" style="display: none;">
                    <div class="warning-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        数据缺失警告
                    </div>
                    <div class="warning-text" id="warningText">
                        未检测到前面步骤的选择数据，将使用默认时间和位置进行计算。
                    </div>
                    <button class="btn btn-outline" onclick="goBackToStep(1)">
                        <i class="fas fa-arrow-left"></i> 返回时间选择
                    </button>
                </div>
            </div>

            <div class="control-group">
                <label class="info-label">观测时间</label>
                <input type="datetime-local" id="timeInput" class="w-full p-2 bg-gray-800 text-white border border-gray-600 rounded mt-2">
                <button id="updateBtn" class="btn btn-primary mt-2">更新星图</button>
            </div>

            <div class="control-group">
                <label class="info-label">音乐时长设置</label>
                <div class="duration-control">
                    <input type="number" id="durationInput" class="duration-input" value="45" min="15" max="180" step="5">
                    <span class="text-xs text-gray-400">秒</span>
                </div>
                <div class="flex gap-1 mt-2">
                    <button class="duration-preset" data-duration="30">30s</button>
                    <button class="duration-preset active" data-duration="45">45s</button>
                    <button class="duration-preset" data-duration="60">60s</button>
                    <button class="duration-preset" data-duration="90">90s</button>
                </div>
                <div class="text-xs text-gray-400 mt-1">推荐45秒，生成更完整的音乐作品</div>
            </div>

            <div class="control-group">
                <label class="info-label">旋转控制</label>
                <div class="rotation-controls mt-2">
                    <button id="pauseBtn" class="rotation-btn active">暂停</button>
                    <button id="slowBtn" class="rotation-btn">慢速</button>
                    <button id="normalBtn" class="rotation-btn">正常</button>
                    <button id="fastBtn" class="rotation-btn">快速</button>
                </div>
            </div>

            <div class="control-group">
                <label class="info-label">显示选项</label>
                <div class="mt-2 space-y-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="showLabels" checked class="mr-2">
                        <span>显示星宿标注</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="showLines" checked class="mr-2">
                        <span>显示连线</span>
                    </label>
                    <label class="flex items-center">
                        <input type="checkbox" id="showBackground" checked class="mr-2">
                        <span>显示背景星空</span>
                    </label>
                </div>
            </div>

            <div class="constellation-legend">
                <div class="section-title">四象图例</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4facfe;"></div>
                    <span>东方青龙 (7宿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>南方朱雀 (7宿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffffff;"></div>
                    <span>西方白虎 (7宿)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #a8a8a8;"></div>
                    <span>北方玄武 (7宿)</span>
                </div>
            </div>

            <button id="generateMusicBtn" class="btn btn-secondary">
                <i class="fas fa-music"></i> 生成音乐
            </button>
        </div>

        <!-- 星图区域 -->
        <div class="star-canvas-container">
            <canvas id="starCanvas"></canvas>
            <div class="status-indicator" id="statusIndicator">初始化中...</div>
            <div class="loading" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <div id="loadingText">加载中...</div>
            </div>
        </div>

        <!-- 信息面板 -->
        <div class="info-panel">
            <div class="section-title">
                <i class="fas fa-moon"></i>
                天文信息
            </div>
            <div class="info-item">
                <span class="info-label">当前时间:</span>
                <span class="info-value" id="currentTime">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">月亮星宿:</span>
                <span class="info-value" id="moonMansion">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">对应五行:</span>
                <span class="info-value" id="element">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">黄经度数:</span>
                <span class="info-value" id="eclipticLon">--°</span>
            </div>

            <div class="section-title mt-6">
                <i class="fas fa-music"></i>
                音乐参数
                <span class="duration-display" id="durationDisplay">45秒</span>
            </div>
            <div class="info-item">
                <span class="info-label">乐器:</span>
                <span class="info-value" id="instrument">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">调式:</span>
                <span class="info-value" id="mode">--</span>
            </div>
            <div class="info-item">
                <span class="info-label">风格:</span>
                <span class="info-value">cinematic, ethereal</span>
            </div>

            <div class="section-title mt-6">
                <i class="fas fa-play"></i>
                音乐播放器
            </div>
            
            <div id="musicStatusContainer">
                <div class="music-status-card status-loading" id="musicStatusCard">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-info-circle"></i>
                        <span class="font-bold">准备生成音乐</span>
                    </div>
                    <div id="musicStatusText">点击"生成音乐"按钮开始</div>
                </div>
            </div>

            <div id="musicParamsDisplay" style="display: none;">
                <div class="music-params">
                    <div class="param-item">
                        <span class="param-label">星宿:</span>
                        <span class="param-value" id="paramMansion">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">五行:</span>
                        <span class="param-value" id="paramElement">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">乐器:</span>
                        <span class="param-value" id="paramInstrument">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">调式:</span>
                        <span class="param-value" id="paramMode">--</span>
                    </div>
                    <div class="param-item">
                        <span class="param-label">时长:</span>
                        <span class="param-value" id="paramDuration">--</span>
                    </div>
                </div>
            </div>

            <div id="enhancedPromptDisplay" style="display: none;">
                <div class="enhanced-prompt">
                    <span class="prompt-label">
                        <i class="fas fa-magic"></i> 增强提示词：
                    </span>
                    <div id="enhancedPromptText">--</div>
                </div>
            </div>

            <audio id="musicPlayer" controls class="w-full mt-3" style="display: none;"></audio>
            
            <div id="retrySection" style="display: none;">
                <div class="retry-options">
                    <button id="retryBtn" class="retry-btn btn-warning">
                        <i class="fas fa-redo"></i> 重试
                    </button>
                    <button id="forceRetryBtn" class="retry-btn btn-primary">
                        <i class="fas fa-bolt"></i> 强制重试
                    </button>
                </div>
                <div class="timeout-help mt-3">
                    <div class="help-title">
                        <i class="fas fa-lightbulb"></i>
                        遇到超时问题？
                    </div>
                    <div>• 外部音乐服务可能繁忙</div>
                    <div>• 较长时长的音乐需要更多生成时间</div>
                    <div>• 天文计算已完成，只需重新生成音频</div>
                </div>
            </div>

            <div id="downloadSection" style="display: none;" class="mt-4">
                <button id="downloadMusic" class="btn btn-success mb-2">
                    <i class="fas fa-download"></i> 下载音乐
                </button>
                <button id="downloadSheet" class="btn btn-success">
                    <i class="fas fa-file-pdf"></i> 下载乐谱
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript代码 -->
    <script>
        // 全局变量
        let scene, camera, renderer, starField, rotationSpeed = 0;
        let constellationGroups = [];
        let isRotating = false;
        let currentData = null;
        let retryCount = 0;
        let maxRetries = 3;
        let selectedTimeData = null;
        let selectedLocationData = null;

        // Three.js CDN加载
        (function() {
            const cdnSources = [
                'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
                'https://unpkg.com/three@0.128.0/build/three.min.js'
            ];

            let currentCDN = 0;

            function loadThreeJS() {
                if (currentCDN >= cdnSources.length) {
                    console.error('所有Three.js CDN都加载失败');
                    document.getElementById('statusIndicator').textContent = 'Three.js加载失败';
                    document.getElementById('statusIndicator').className = 'status-indicator error';
                    return;
                }

                const script = document.createElement('script');
                script.src = cdnSources[currentCDN];
                script.onload = function() {
                    console.log('Three.js加载成功:', cdnSources[currentCDN]);
                    initStarMap();
                };
                script.onerror = function() {
                    console.warn('CDN失败:', cdnSources[currentCDN]);
                    currentCDN++;
                    loadThreeJS();
                };
                document.head.appendChild(script);
            }

            loadThreeJS();
        })();

        // 页面加载时读取前面步骤的数据
        window.addEventListener('load', function() {
            loadPreviousStepData();
        });

        // 导航功能
        function goBackToStep(step) {
            if (step === 1) {
                window.location.href = '/';
            } else if (step === 2) {
                window.location.href = '/location';
            }
        }

        // 读取前面步骤的数据
        function loadPreviousStepData() {
            try {
                selectedTimeData = JSON.parse(sessionStorage.getItem('selectedTime') || '{}');
                selectedLocationData = JSON.parse(sessionStorage.getItem('selectedLocation') || '{}');
                
                console.log('读取到的时间数据:', selectedTimeData);
                console.log('读取到的位置数据:', selectedLocationData);
                
                displaySelectedInfo(selectedTimeData, selectedLocationData);
                
                // 如果有选择的时间，设置到时间输入框
                if (selectedTimeData.year && selectedTimeData.month) {
                    const selectedDate = new Date(
                        selectedTimeData.year, 
                        selectedTimeData.month - 1, 
                        selectedTimeData.day, 
                        selectedTimeData.hour
                    );
                    document.getElementById('timeInput').value = selectedDate.toISOString().slice(0, 16);
                } else {
                    // 没有选择时间，使用当前时间
                    setCurrentTime();
                }
                
            } catch (error) {
                console.error('读取步骤数据失败:', error);
                setCurrentTime();
                showDataMissingWarning();
            }
        }

        // 显示已选择的信息
        function displaySelectedInfo(timeData, locationData) {
            const timeInfoEl = document.getElementById('selectedTimeInfo');
            const locationInfoEl = document.getElementById('selectedLocationInfo');
            
            if (timeData && timeData.year) {
                const timeStr = `${timeData.year}年${timeData.month}月${timeData.day}日 ${String(timeData.hour).padStart(2, '0')}:00`;
                const formatted = timeData.formatted || timeStr;
                timeInfoEl.innerHTML = `
                    <div style="font-weight: bold; color: #4facfe;">${formatted}</div>
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">
                        时间戳: ${timeData.timestamp || ''}
                    </div>
                `;
                document.getElementById('dataMissingWarning').style.display = 'none';
            } else {
                timeInfoEl.innerHTML = `
                    <div style="color: #fbbf24;">未选择时间，将使用当前时间</div>
                `;
                showDataMissingWarning('时间');
            }
            
            if (locationData && locationData.latitude) {
                const address = locationData.address || '未知地点';
                locationInfoEl.innerHTML = `
                    <div style="font-weight: bold; color: #4facfe;">${address}</div>
                    <div style="font-size: 11px; color: #888; margin-top: 4px;">
                        经度: ${locationData.longitude.toFixed(4)}°<br>
                        纬度: ${locationData.latitude.toFixed(4)}°
                    </div>
                `;
            } else {
                locationInfoEl.innerHTML = `
                    <div style="color: #fbbf24;">未选择位置，将使用默认位置(香港)</div>
                `;
                showDataMissingWarning('位置');
            }
        }

        // 显示数据缺失警告
        function showDataMissingWarning(missingType = '') {
            const warningEl = document.getElementById('dataMissingWarning');
            const warningTextEl = document.getElementById('warningText');
            
            let warningText = '未检测到前面步骤的选择数据，将使用默认时间和位置进行计算。';
            if (missingType === '时间') {
                warningText = '未检测到时间选择数据，将使用当前时间进行计算。建议返回第一步重新选择时间。';
            } else if (missingType === '位置') {
                warningText = '未检测到位置选择数据，将使用默认位置(香港)进行计算。建议返回第二步重新选择位置。';
            }
            
            warningTextEl.textContent = warningText;
            warningEl.style.display = 'block';
        }

        // 星宿数据
        const CONSTELLATION_DATA = {
            // 东方青龙七宿
            "角": {
                color: "#4facfe",
                stars: [
                    {name: "角宿一", ra: 201.298, dec: -11.161, mag: 0.97},
                    {name: "角宿二", ra: 213.915, dec: -0.596, mag: 3.38},
                    {name: "角宿三", ra: 201.5, dec: -10.5, mag: 4.2}
                ],
                connections: [[0,1], [1,2], [2,0]]
            },
            "亢": {
                color: "#4facfe",
                stars: [
                    {name: "亢宿一", ra: 215.676, dec: -9.383, mag: 4.16},
                    {name: "亢宿二", ra: 218.877, dec: -12.848, mag: 4.07},
                    {name: "亢宿三", ra: 220.5, dec: -10.2, mag: 4.5},
                    {name: "亢宿四", ra: 216.8, dec: -8.9, mag: 5.1}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0]]
            },
            "心": {
                color: "#4facfe",
                stars: [
                    {name: "心宿一", ra: 243.587, dec: -28.216, mag: 2.89},
                    {name: "心宿二", ra: 247.352, dec: -26.432, mag: 0.96},
                    {name: "心宿三", ra: 245.297, dec: -25.592, mag: 2.70}
                ],
                connections: [[0,1], [1,2]]
            },
            // 南方朱雀七宿
            "井": {
                color: "#ff6b6b",
                stars: [
                    {name: "井宿一", ra: 93.719, dec: 22.514, mag: 3.53},
                    {name: "井宿二", ra: 95.241, dec: 22.964, mag: 4.45},
                    {name: "井宿三", ra: 93.506, dec: 24.398, mag: 3.35},
                    {name: "井宿四", ra: 92.946, dec: 21.982, mag: 4.97}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0], [0,2], [1,3]]
            },
            "鬼": {
                color: "#ff6b6b",
                stars: [
                    {name: "鬼宿一", ra: 130.821, dec: 19.841, mag: 3.94},
                    {name: "鬼宿二", ra: 131.171, dec: 21.469, mag: 4.67},
                    {name: "鬼宿三", ra: 130.109, dec: 20.569, mag: 4.02},
                    {name: "鬼宿四", ra: 129.886, dec: 18.154, mag: 4.26}
                ],
                connections: [[0,1], [1,2], [2,3], [3,0]]
            },
            // 西方白虎七宿
            "昴": {
                color: "#ffffff",
                stars: [
                    {name: "昴宿一", ra: 56.871, dec: 24.105, mag: 5.65},
                    {name: "昴宿二", ra: 57.290, dec: 24.367, mag: 4.30},
                    {name: "昴宿三", ra: 56.217, dec: 24.283, mag: 4.18},
                    {name: "昴宿四", ra: 56.456, dec: 24.011, mag: 5.45},
                    {name: "昴宿五", ra: 56.530, dec: 24.498, mag: 5.76},
                    {name: "昴宿六", ra: 57.297, dec: 24.052, mag: 4.62},
                    {name: "昴宿七", ra: 65.734, dec: 25.948, mag: 4.14}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,6], [6,0], [0,3], [1,4], [2,5]]
            },
            "参": {
                color: "#ffffff",
                stars: [
                    {name: "参宿一", ra: 85.190, dec: -1.202, mag: 1.70},
                    {name: "参宿二", ra: 84.053, dec: -1.944, mag: 2.23},
                    {name: "参宿三", ra: 83.858, dec: -5.910, mag: 2.25},
                    {name: "参宿四", ra: 88.793, dec: 7.407, mag: 0.45},
                    {name: "参宿五", ra: 84.411, dec: -1.201, mag: 2.77},
                    {name: "参宿六", ra: 82.061, dec: -0.180, mag: 2.09},
                    {name: "参宿七", ra: 81.283, dec: 6.350, mag: 1.64}
                ],
                connections: [[0,1], [1,2], [3,4], [4,5], [5,6], [6,3]]
            },
            // 北方玄武七宿
            "斗": {
                color: "#a8a8a8",
                stars: [
                    {name: "斗宿一", ra: 278.110, dec: -25.421, mag: 3.17},
                    {name: "斗宿二", ra: 279.234, dec: -26.297, mag: 2.81},
                    {name: "斗宿三", ra: 285.653, dec: -29.828, mag: 3.93},
                    {name: "斗宿四", ra: 290.660, dec: -30.424, mag: 2.60},
                    {name: "斗宿五", ra: 296.565, dec: -29.578, mag: 3.89},
                    {name: "斗宿六", ra: 298.969, dec: -26.684, mag: 2.02}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5]]
            },
            "牛": {
                color: "#a8a8a8",
                stars: [
                    {name: "牛宿一", ra: 304.413, dec: -12.759, mag: 3.08},
                    {name: "牛宿二", ra: 308.300, dec: -17.847, mag: 4.28},
                    {name: "牛宿三", ra: 311.553, dec: -17.233, mag: 4.51},
                    {name: "牛宿四", ra: 307.372, dec: -24.779, mag: 4.07},
                    {name: "牛宿五", ra: 309.387, dec: -14.781, mag: 4.48},
                    {name: "牛宿六", ra: 314.293, dec: -18.299, mag: 4.11}
                ],
                connections: [[0,1], [1,2], [2,3], [3,4], [4,5], [5,0]]
            }
        };

        function initStarMap() {
            try {
                if (typeof THREE === 'undefined') {
                    throw new Error('THREE.js未定义');
                }

                const canvas = document.getElementById('starCanvas');
                const container = canvas.parentElement;

                // 创建场景
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
                
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setClearColor(0x000011, 1);

                // 创建星空背景
                createBackgroundStars();
                
                // 创建星宿群组
                createConstellationGroups();

                // 设置相机位置
                camera.position.set(0, 0, 150);

                // 设置事件监听
                setupEventListeners();
                
                // 开始动画循环
                animate();

                // 更新天文数据
                updateAstronomyData();

                document.getElementById('statusIndicator').textContent = '星图加载完成';

            } catch (error) {
                console.error('星图初始化失败:', error);
                document.getElementById('statusIndicator').textContent = '初始化失败: ' + error.message;
                document.getElementById('statusIndicator').className = 'status-indicator error';
            }
        }

        function createBackgroundStars() {
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 2000;
            const positions = new Float32Array(starCount * 3);
            const colors = new Float32Array(starCount * 3);

            for (let i = 0; i < starCount; i++) {
                const radius = 80;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                positions[i * 3] = radius * Math.sin(phi) * Math.cos(theta);
                positions[i * 3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                positions[i * 3 + 2] = radius * Math.cos(phi);
                
                const brightness = Math.random() * 0.8 + 0.2;
                colors[i * 3] = brightness;
                colors[i * 3 + 1] = brightness;
                colors[i * 3 + 2] = brightness;
            }

            starGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            starGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const starMaterial = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.6
            });

            starField = new THREE.Points(starGeometry, starMaterial);
            scene.add(starField);
        }

        function createConstellationGroups() {
            Object.entries(CONSTELLATION_DATA).forEach(([name, data]) => {
                const group = new THREE.Group();
                group.name = name;

                // 创建星宿中的星星
                const starMeshes = [];
                data.stars.forEach((star, index) => {
                    const position = sphericalToCartesian(star.ra, star.dec, 90);
                    
                    // 根据星等设置大小
                    const size = Math.max(0.3, (6 - star.mag) * 0.3);
                    const starGeometry = new THREE.SphereGeometry(size, 8, 8);
                    const starMaterial = new THREE.MeshBasicMaterial({ 
                        color: new THREE.Color(data.color),
                        transparent: true,
                        opacity: 0.9
                    });
                    
                    const starMesh = new THREE.Mesh(starGeometry, starMaterial);
                    starMesh.position.copy(position);
                    starMesh.userData = { name: star.name, magnitude: star.mag };
                    
                    group.add(starMesh);
                    starMeshes.push(starMesh);
                });

                // 创建连线
                if (data.connections && data.connections.length > 0) {
                    const lineGeometry = new THREE.BufferGeometry();
                    const positions = [];
                    
                    data.connections.forEach(connection => {
                        const start = starMeshes[connection[0]].position;
                        const end = starMeshes[connection[1]].position;
                        positions.push(start.x, start.y, start.z);
                        positions.push(end.x, end.y, end.z);
                    });
                    
                    lineGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
                    
                    const lineMaterial = new THREE.LineBasicMaterial({
                        color: new THREE.Color(data.color),
                        transparent: true,
                        opacity: 0.6,
                        linewidth: 2
                    });
                    
                    const lines = new THREE.LineSegments(lineGeometry, lineMaterial);
                    group.add(lines);
                }

                // 创建标签
                const labelCanvas = document.createElement('canvas');
                labelCanvas.width = 128;
                labelCanvas.height = 64;
                const ctx = labelCanvas.getContext('2d');
                
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, 128, 64);
                ctx.fillStyle = data.color;
                ctx.font = 'bold 20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(name + '宿', 64, 35);
                
                const labelTexture = new THREE.CanvasTexture(labelCanvas);
                const labelMaterial = new THREE.MeshBasicMaterial({ 
                    map: labelTexture, 
                    transparent: true 
                });
                const labelGeometry = new THREE.PlaneGeometry(8, 4);
                const labelMesh = new THREE.Mesh(labelGeometry, labelMaterial);
                
                // 计算星宿中心位置
                const centerPosition = new THREE.Vector3();
                starMeshes.forEach(star => centerPosition.add(star.position));
                centerPosition.divideScalar(starMeshes.length);
                centerPosition.normalize().multiplyScalar(95);
                
                labelMesh.position.copy(centerPosition);
                group.add(labelMesh);

                scene.add(group);
                constellationGroups.push(group);
            });
        }

        function sphericalToCartesian(ra, dec, radius) {
            const phi = (90 - dec) * Math.PI / 180;
            const theta = ra * Math.PI / 180;
            
            return new THREE.Vector3(
                radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        function setupEventListeners() {
            const canvas = document.getElementById('starCanvas');
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            // 鼠标控制
            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                previousMousePosition = { x: e.clientX, y: e.clientY };
            });

            canvas.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const deltaMove = {
                        x: e.clientX - previousMousePosition.x,
                        y: e.clientY - previousMousePosition.y
                    };

                    scene.rotation.y += deltaMove.x * 0.01;
                    scene.rotation.x += deltaMove.y * 0.01;

                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            // 滚轮缩放
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const zoom = e.deltaY > 0 ? 1.1 : 0.9;
                camera.position.multiplyScalar(zoom);
                
                const distance = camera.position.length();
                if (distance < 50) camera.position.normalize().multiplyScalar(50);
                if (distance > 300) camera.position.normalize().multiplyScalar(300);
            });

            // 时长控制
            const durationInput = document.getElementById('durationInput');
            const durationDisplay = document.getElementById('durationDisplay');
            
            durationInput.addEventListener('input', (e) => {
                const duration = parseInt(e.target.value);
                durationDisplay.textContent = `${duration}秒`;
                updateDurationPresets(duration);
            });

            // 时长预设按钮
            document.querySelectorAll('.duration-preset').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const duration = parseInt(e.target.dataset.duration);
                    durationInput.value = duration;
                    durationDisplay.textContent = `${duration}秒`;
                    updateDurationPresets(duration);
                });
            });

            // 旋转控制按钮
            document.getElementById('pauseBtn').addEventListener('click', () => setRotationSpeed(0));
            document.getElementById('slowBtn').addEventListener('click', () => setRotationSpeed(0.001));
            document.getElementById('normalBtn').addEventListener('click', () => setRotationSpeed(0.005));
            document.getElementById('fastBtn').addEventListener('click', () => setRotationSpeed(0.02));

            // 其他控件
            document.getElementById('updateBtn').addEventListener('click', updateAstronomyData);
            document.getElementById('generateMusicBtn').addEventListener('click', generateMusic);

            // 重试按钮
            document.getElementById('retryBtn').addEventListener('click', () => retryMusic(false));
            document.getElementById('forceRetryBtn').addEventListener('click', () => retryMusic(true));

            // 显示选项
            document.getElementById('showLabels').addEventListener('change', toggleLabels);
            document.getElementById('showLines').addEventListener('change', toggleLines);
            document.getElementById('showBackground').addEventListener('change', toggleBackground);

            // 窗口大小变化
            window.addEventListener('resize', () => {
                const container = canvas.parentElement;
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });
        }

        function updateDurationPresets(activeDuration) {
            document.querySelectorAll('.duration-preset').forEach(btn => {
                const btnDuration = parseInt(btn.dataset.duration);
                btn.classList.toggle('active', btnDuration === activeDuration);
            });
        }

        function setRotationSpeed(speed) {
            rotationSpeed = speed;
            isRotating = speed > 0;

            document.querySelectorAll('.rotation-btn').forEach(btn => btn.classList.remove('active'));
            
            if (speed === 0) document.getElementById('pauseBtn').classList.add('active');
            else if (speed === 0.001) document.getElementById('slowBtn').classList.add('active');
            else if (speed === 0.005) document.getElementById('normalBtn').classList.add('active');
            else if (speed === 0.02) document.getElementById('fastBtn').classList.add('active');
        }

        function toggleLabels(e) {
            constellationGroups.forEach(group => {
                const labels = group.children.filter(child => child.type === 'Mesh' && child.material.map);
                labels.forEach(label => label.visible = e.target.checked);
            });
        }

        function toggleLines(e) {
            constellationGroups.forEach(group => {
                const lines = group.children.filter(child => child.type === 'LineSegments');
                lines.forEach(line => line.visible = e.target.checked);
            });
        }

        function toggleBackground(e) {
            if (starField) starField.visible = e.target.checked;
        }

        function animate() {
            requestAnimationFrame(animate);

            if (isRotating) {
                scene.rotation.y += rotationSpeed;
            }

            // 标签始终面向相机
            constellationGroups.forEach(group => {
                const labels = group.children.filter(child => child.type === 'Mesh' && child.material.map);
                labels.forEach(label => label.lookAt(camera.position));
            });

            renderer.render(scene, camera);
        }

        function setCurrentTime() {
            const now = new Date();
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('timeInput').value = timeString;
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        async function updateAstronomyData() {
            try {
                // 检查是否有前面步骤的数据
                if (selectedTimeData && selectedTimeData.year && selectedLocationData && selectedLocationData.latitude) {
                    // 使用前面步骤选择的数据
                    const requestData = {
                        time_data: selectedTimeData,
                        location_data: selectedLocationData
                    };
                    
                    console.log('使用选择的数据进行天文计算:', requestData);
                    
                    const response = await fetch('/api/astronomy/calculate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    
                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || '获取数据失败');
                    
                    currentData = data;
                    updateUI(data);
                    highlightMoonMansion(data.current_mansion || data.mansion);
                    
                } else {
                    // 使用当前时间输入框的值（兼容原有逻辑）
                    const timeInput = document.getElementById('timeInput').value;
                    const params = new URLSearchParams();
                    if (timeInput) params.append('date', timeInput);

                    const response = await fetch(`/api/mansion?${params}`);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);

                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || '获取数据失败');

                    currentData = data;
                    updateUI(data);
                    highlightMoonMansion(data.mansion);
                }

            } catch (error) {
                console.error('更新天文数据失败:', error);
                showMusicStatus('error', '数据更新失败', error.message);
            }
        }

        function updateUI(data) {
            const timeStr = data.request_time || data.timestamp || new Date().toISOString();
            document.getElementById('currentTime').textContent = new Date(timeStr).toLocaleString('zh-CN');
            document.getElementById('moonMansion').textContent = (data.current_mansion || data.mansion) + '宿';
            document.getElementById('element').textContent = data.element;
            document.getElementById('eclipticLon').textContent = (data.ecliptic_longitude || data.moon_ecliptic_lon || 0).toFixed(2) + '°';
            document.getElementById('instrument').textContent = data.instrument || data.music_config?.instrument || '--';
            document.getElementById('mode').textContent = data.mode || data.music_config?.mode || '--';
        }

        function highlightMoonMansion(mansion) {
            constellationGroups.forEach(group => {
                const isCurrentMansion = group.name === mansion;
                group.children.forEach(child => {
                    if (child.material) {
                        if (isCurrentMansion) {
                            child.material.opacity = 1.0;
                            if (child.material.emissive) {
                                child.material.emissive.setHex(0x331100);
                            }
                        } else {
                            child.material.opacity = 0.6;
                            if (child.material.emissive) {
                                child.material.emissive.setHex(0x000000);
                            }
                        }
                    }
                });
            });
        }

        async function generateMusic() {
            if (!currentData) {
                showMusicStatus('error', '请先更新天文数据', '需要先获取天文信息才能生成音乐');
                return;
            }

            const generateBtn = document.getElementById('generateMusicBtn');
            const originalText = generateBtn.innerHTML;
            const duration = parseInt(document.getElementById('durationInput').value);
            
            try {
                // 禁用按钮，显示加载状态
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';
                generateBtn.disabled = true;
                
                showMusicStatus('loading', `正在生成${duration}秒音乐...`, '正在计算天文参数并调用音乐生成服务');
                showLoadingIndicator(true, `生成${duration}秒音乐中...`);
                
                // 从当前数据中获取音乐参数，确保不是undefined
                const instrument = currentData.instrument || currentData.music_config?.instrument || 'Piano';
                const mode = currentData.mode || currentData.music_config?.mode || 'Major';
                
                console.log('使用音乐参数:', { instrument, mode, duration });
                console.log('当前天文数据:', currentData);
                
                // 检查参数有效性
                if (!instrument || instrument === 'undefined' || instrument === '--') {
                    throw new Error('无法获取有效的乐器参数，请先更新天文数据');
                }
                if (!mode || mode === 'undefined' || mode === '--') {
                    throw new Error('无法获取有效的调式参数，请先更新天文数据');
                }
                
                const params = new URLSearchParams({
                    instrument: instrument,
                    mode: mode,
                    style: 'cinematic, ethereal',
                    duration: duration
                });
                
                console.log('发送音乐生成请求:', params.toString());
                
                const response = await fetch(`/api/music/generate?${params}`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`服务器错误: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('收到音乐生成响应:', result);
                
                if (!result.success) {
                    throw new Error(result.error || '音乐生成失败');
                }

                handleMusicResult(result);

            } catch (error) {
                console.error('音乐生成失败:', error);
                showMusicStatus('error', '音乐生成失败', error.message);
                retryCount = 0;
                showRetryOptions(true);
            } finally {
                generateBtn.innerHTML = originalText;
                generateBtn.disabled = false;
                showLoadingIndicator(false);
            }
        }

        function handleMusicResult(result) {
            console.log('处理音乐结果:', result);

            // 显示音乐参数
            if (result.parameters) {
                showMusicParams(result.astronomy, result.parameters);
                
                // 显示增强提示词
                if (result.parameters.enhanced_prompt) {
                    showEnhancedPrompt(result.parameters.enhanced_prompt);
                }
            }

            // 检查音乐生成是否成功
            if (result.music && result.music.success !== false) {
                const duration = result.parameters?.duration || 45;
                
                // 检查是否有download_url
                if (result.music.download_url) {
                    showMusicStatus('success', `${duration}秒音乐生成成功！`, '正在加载音频文件...');
                    loadAndPlayAudio(result.music.download_url, result.music.pdf_download_url);
                    showRetryOptions(false);
                } else if (result.music.id || (typeof result.music === 'string' && result.music.length > 0)) {
                    // 没有download_url，但有ID，尝试构造URL
                    const musicId = result.music.id || result.music;
                    console.log('尝试构造音频URL，ID:', musicId);
                    
                    // 根据您的音乐API调整URL构造方式
                    const downloadUrl = `https://yue-inst.ngrok.app/download/${musicId}`;
                    showMusicStatus('success', `${duration}秒音乐生成成功！`, '正在加载音频文件...');
                    loadAndPlayAudio(downloadUrl);
                    showRetryOptions(false);
                } else {
                    showMusicStatus('warning', '音乐生成完成但无法获取音频文件', '服务器返回了结果但没有可用的下载链接');
                    showRetryOptions(true);
                }
                
            } else if (result.music && result.music.success === false) {
                // 音乐生成失败，但天文计算成功
                const errorMsg = result.music.error || '外部音乐服务超时';
                const duration = result.parameters?.duration || 45;
                showMusicStatus('warning', `${duration}秒音乐参数生成成功`, 
                    `天文计算已完成，但音频生成失败：${errorMsg}`);
                showRetryOptions(true);
                
            } else {
                // 无音乐数据
                const duration = result.parameters?.duration || 45;
                showMusicStatus('warning', `${duration}秒音乐参数生成成功`, 
                    '天文数据计算完成，但音频文件生成失败，请重试');
                showRetryOptions(true);
            }
        }

        function showMusicParams(astronomy, parameters) {
            document.getElementById('paramMansion').textContent = astronomy.mansion + '宿';
            document.getElementById('paramElement').textContent = parameters.element;
            document.getElementById('paramInstrument').textContent = parameters.instrument;
            document.getElementById('paramMode').textContent = parameters.mode;
            document.getElementById('paramDuration').textContent = (parameters.duration || 45) + '秒';
            document.getElementById('musicParamsDisplay').style.display = 'block';
        }

        function showEnhancedPrompt(prompt) {
            document.getElementById('enhancedPromptText').textContent = prompt;
            document.getElementById('enhancedPromptDisplay').style.display = 'block';
        }

        async function loadAndPlayAudio(audioUrl, pdfUrl = null) {
            const player = document.getElementById('musicPlayer');
            
            try {
                showMusicStatus('loading', '加载音频文件...', '正在从服务器加载音乐文件');
                
                // 显示播放器
                player.style.display = 'block';
                player.src = audioUrl;
                
                // 添加音频事件监听器
                player.onloadstart = () => {
                    showMusicStatus('loading', '正在加载音频...', '音频文件开始下载');
                };
                
                player.oncanplay = () => {
                    showMusicStatus('success', '音频加载完成', '可以开始播放音乐');
                };
                
                player.onplaying = () => {
                    showMusicStatus('success', '正在播放音乐 🎵', '享受由星宿生成的美妙音乐');
                };
                
                player.onpause = () => {
                    showMusicStatus('success', '音乐已暂停', '点击播放按钮继续');
                };
                
                player.onended = () => {
                    showMusicStatus('success', '播放完成', '音乐播放结束');
                };
                
                player.onerror = (e) => {
                    console.error('音频播放错误:', e);
                    const errorCode = player.error ? player.error.code : '未知';
                    const errorMsg = getAudioErrorMessage(errorCode);
                    showMusicStatus('error', '音频播放失败', `${errorMsg} (错误代码: ${errorCode})`);
                    showRetryOptions(true);
                };
                
                // 设置下载按钮
                setupDownloadButtons(audioUrl, pdfUrl);
                
                // 尝试自动播放
                try {
                    await player.play();
                    showMusicStatus('success', '自动播放已开始 🎵', '正在播放根据星宿生成的音乐');
                } catch (autoplayError) {
                    console.log('自动播放被阻止:', autoplayError);
                    showMusicStatus('success', '音频已就绪', '由于浏览器策略，请手动点击播放按钮');
                }
                
            } catch (error) {
                console.error('音频处理失败:', error);
                showMusicStatus('error', '音频处理失败', error.message);
                showRetryOptions(true);
            }
        }

        function getAudioErrorMessage(errorCode) {
            const errorMessages = {
                1: '音频文件被中止加载',
                2: '网络错误导致音频加载失败',
                3: '音频文件解码失败',
                4: '不支持的音频格式'
            };
            return errorMessages[errorCode] || '未知的音频错误';
        }

        function setupDownloadButtons(audioUrl, pdfUrl) {
            const downloadSection = document.getElementById('downloadSection');
            const downloadMusic = document.getElementById('downloadMusic');
            const downloadSheet = document.getElementById('downloadSheet');
            
            if (audioUrl) {
                downloadMusic.onclick = () => {
                    const link = document.createElement('a');
                    link.href = audioUrl;
                    const timestamp = new Date().getTime();
                    const mansion = currentData?.mansion || currentData?.current_mansion || '星宿';
                    link.download = `${mansion}音乐_${timestamp}.mp3`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                downloadMusic.style.display = 'block';
            }
            
            if (pdfUrl) {
                downloadSheet.onclick = () => {
                    const link = document.createElement('a');
                    link.href = pdfUrl;
                    const timestamp = new Date().getTime();
                    const mansion = currentData?.mansion || currentData?.current_mansion || '星宿';
                    link.download = `${mansion}乐谱_${timestamp}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                downloadSheet.style.display = 'block';
            }
            
            if (audioUrl || pdfUrl) {
                downloadSection.style.display = 'block';
            }
        }

        function showMusicStatus(type, title, description) {
            const card = document.getElementById('musicStatusCard');
            
            // 移除所有状态类
            card.className = 'music-status-card';
            
            // 添加对应状态类
            card.classList.add(`status-${type}`);
            
            // 设置图标
            let icon;
            switch (type) {
                case 'success':
                    icon = 'fas fa-check-circle';
                    break;
                case 'warning':
                    icon = 'fas fa-exclamation-triangle';
                    break;
                case 'error':
                    icon = 'fas fa-times-circle';
                    break;
                case 'loading':
                    icon = 'fas fa-spinner fa-spin';
                    break;
                default:
                    icon = 'fas fa-info-circle';
            }
            
            // 更新内容
            card.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <i class="${icon}"></i>
                    <span class="font-bold">${title}</span>
                </div>
                <div id="musicStatusText">${description}</div>
            `;
        }

        function showRetryOptions(show) {
            const retrySection = document.getElementById('retrySection');
            retrySection.style.display = show ? 'block' : 'none';
            
            if (show) {
                // 更新重试按钮状态
                const retryBtn = document.getElementById('retryBtn');
                const forceRetryBtn = document.getElementById('forceRetryBtn');
                
                retryBtn.innerHTML = `<i class="fas fa-redo"></i> 重试 (${retryCount + 1}/${maxRetries})`;
                
                if (retryCount >= maxRetries - 1) {
                    retryBtn.disabled = true;
                    forceRetryBtn.innerHTML = '<i class="fas fa-bolt"></i> 强制重试';
                }
            }
        }

        async function retryMusic(force = false) {
            if (!force && retryCount >= maxRetries) {
                showMusicStatus('error', '重试次数已达上限', '请稍后再试或检查网络连接');
                return;
            }
            
            if (!force) {
                retryCount++;
            } else {
                retryCount = 0; // 强制重试时重置计数
            }
            
            // 等待一段时间后重试
            const waitTime = force ? 1000 : (retryCount * 2000);
            const duration = parseInt(document.getElementById('durationInput').value);
            showMusicStatus('loading', '准备重试...', `等待 ${waitTime/1000} 秒后重新生成${duration}秒音乐`);
            
            setTimeout(() => {
                generateMusic();
            }, waitTime);
        }

        function showLoadingIndicator(show, text = '加载中...') {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadingText = document.getElementById('loadingText');
            
            if (show) {
                loadingText.textContent = text;
                loadingIndicator.style.display = 'block';
            } else {
                loadingIndicator.style.display = 'none';
            }
        }
    </script>
</body>
</html>